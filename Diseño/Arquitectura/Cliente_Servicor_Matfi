@startuml ArquitecturaClienteServidor_MatFi_Completa

skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam packageStyle rectangle

title Arquitectura Cliente-Servidor - MatFi\nAplicación Web con APIs REST

' ==================== CAPA CLIENTE ====================
package "CLIENTE (Navegador Web)" #E8F4F8 {
    
    component "HTML5" as html
    component "CSS3" as css
    component "JavaScript ES6+" as js
    
    package "Módulos Frontend" #F0F8FF {
        [api.js\nConsumo APIs] as apiJS
        [auth.js\nAutenticación] as authJS
        [ui.js\nManipulación DOM] as uiJS
        [state.js\nEstado app] as stateJS
        [utils.js\nUtilidades] as utilsJS
    }
    
    database "LocalStorage" as localStorage {
        [Token JWT]
        [Preferencias]
    }
}

html -[hidden]down-> apiJS
css -[hidden]down-> authJS
js -down-> apiJS
js -down-> authJS
js -down-> uiJS
authJS -down-> localStorage

' ==================== RED ====================
cloud "Internet (HTTPS/TLS)" as internet

apiJS -down-> internet : "HTTP Requests\nJSON"
internet -up-> apiJS : "HTTP Responses\nJSON"

' ==================== CAPA SERVIDOR ====================
package "SERVIDOR (Node.js + Express)" #D4E6F1 {
    
    component "Express Server\nPuerto 3000" as express
    
    package "Middleware Global" #FFCCBC {
        [CORS] as cors
        [Body Parser] as bodyParser
        [Error Handler] as errorHandler
    }
    
    package "API REST Endpoints" #E1F5FE {
        
        package "Auth Routes" #FFE5CC {
            [POST /api/auth/register]
            [POST /api/auth/login]
            [POST /api/auth/logout]
        }
        
        package "Usuario Routes" #FFF9C4 {
            [GET /api/usuarios/:id]
            [PUT /api/usuarios/:id]
            [PUT /api/usuarios/:id/password]
        }
        
        package "Rutina Routes" #C8E6C9 {
            [GET /api/rutinas]
            [GET /api/rutinas/:id]
            [POST /api/usuarios/:id/rutinas]
        }
        
        package "Receta Routes" #FFE0B2 {
            [GET /api/recetas]
            [GET /api/recetas/:id]
            [POST /api/usuarios/:id/recetas/favoritas]
        }
        
        package "Registro Routes" #E1BEE7 {
            [POST /api/usuarios/:id/entrenamientos]
            [POST /api/usuarios/:id/agua]
            [GET /api/usuarios/:id/progreso]
        }
    }
    
    package "Controllers (MVC)" #B3E5FC {
        [authController] as authCtrl
        [usuarioController] as userCtrl
        [rutinaController] as rutCtrl
        [recetaController] as recCtrl
        [registroController] as regCtrl
    }
    
    package "Middleware de Auth" #FFCCBC {
        [authMiddleware\nVerificar JWT] as authMW
        [validationMiddleware\nValidar datos] as valMW
    }
    
    package "Models (Acceso a Datos)" #CE93D8 {
        [Usuario.js] as userModel
        [Rutina.js] as rutModel
        [Receta.js] as recModel
        [Entrenamiento.js] as entModel
        [Registro.js] as regModel
    }
    
    package "Services" #E1BEE7 {
        [authService\nBcrypt + JWT] as authSvc
        [validationService] as valSvc
    }
}

internet -down-> express
express -down-> cors
cors -down-> bodyParser

bodyParser -down-> [POST /api/auth/register]
bodyParser -down-> [POST /api/auth/login]

[POST /api/auth/register] -down-> authCtrl
[POST /api/auth/login] -down-> authCtrl
[GET /api/usuarios/:id] -down-> authMW
[GET /api/rutinas] -down-> authMW

authMW -down-> valMW
valMW -down-> userCtrl
valMW -down-> rutCtrl
valMW -down-> recCtrl
valMW -down-> regCtrl

authCtrl -right-> authSvc
userCtrl -right-> valSvc

authCtrl -down-> userModel
userCtrl -down-> userModel
rutCtrl -down-> rutModel
recCtrl -down-> recModel
regCtrl -down-> regModel

' ==================== BASE DE DATOS ====================
database "MySQL Database\nmatfi_db" as mysql #FFF9C4 {
    
    package "Tablas Usuario" {
        [usuario]
        [objetivo]
        [progreso_semanal]
        [registro_agua]
    }
    
    package "Tablas Entrenamiento" {
        [nivel_entrenamiento]
        [rutina]
        [entrenamiento]
        [ejercicio]
        [entrenamiento_ejercicio]
        [usuario_rutina]
        [registro_entrenamiento]
    }
    
    package "Tablas Recetas" {
        [categoria_receta]
        [receta]
        [receta_favorita]
    }
}

userModel -down-> [usuario]
rutModel -down-> [rutina]
rutModel -down-> [entrenamiento]
recModel -down-> [receta]
regModel -down-> [registro_entrenamiento]
regModel -down-> [registro_agua]

[usuario] -[hidden]right-> [nivel_entrenamiento]
[nivel_entrenamiento] -[hidden]right-> [categoria_receta]

' ==================== NOTAS ====================
note top of html
  **Cliente (Frontend)**
  • HTML5 + CSS3
  • Vanilla JavaScript ES6+
  • Fetch API para HTTP
  • LocalStorage para tokens
  • Responsivo
end note

note top of express
  **Servidor (Backend)**
  • Node.js v18+
  • Express.js 4.x
  • Patrón MVC
  • APIs REST
  • JWT para auth
end note

note bottom of mysql
  **Base de Datos**
  • MySQL 8.0+
  • Motor InnoDB
  • UTF-8 (utf8mb4)
  • Normalizada 3NF
  • 14 tablas
end note

note right of authMW
  Valida token JWT
  en todas las rutas
  protegidas
end note

' ==================== FLUJO ====================
legend bottom
  **FLUJO DE PETICIÓN COMPLETA:**
  
  1. Usuario interactúa con interfaz HTML
  2. JavaScript (api.js) hace HTTP request con Fetch
  3. Request viaja por internet (HTTPS)
  4. Express recibe en puerto 3000
  5. Middleware CORS y Body Parser procesan
  6. Router identifica endpoint
  7. authMiddleware verifica JWT (si aplica)
  8. validationMiddleware valida datos
  9. Controller ejecuta lógica de negocio
  10. Controller llama a Services si necesita
  11. Model ejecuta queries SQL en MySQL
  12. MySQL retorna resultados
  13. Model procesa datos
  14. Controller formatea respuesta JSON
  15. Express envía HTTP response
  16. JavaScript recibe JSON
  17. ui.js actualiza DOM
  18. Usuario ve resultado
  
  **Tecnologías:**
  Frontend: HTML5, CSS3, Vanilla JS ES6+
  Backend: Node.js, Express.js, MySQL2, JWT, Bcrypt
  Base de Datos: MySQL 8.0+ (14 tablas normalizadas)
end legend

@enduml
